FROM node:20.19-bullseye-slim

# Install optional build tools required by some native modules
RUN apt-get update && \
    apt-get install -y --no-install-recommends build-essential python3 git ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files first for better caching
COPY package*.json ./

# Install dependencies once in the image
RUN npm ci --no-audit --prefer-offline --no-fund --silent

# Create non-root user and set ownership
RUN groupadd -r app && useradd -r -g app app && chown -R app:app /app
USER app

# Copy source (when using bind-mount this is overwritten by host files)
COPY --chown=app:app . .

ENV HOST=0.0.0.0
ENV PORT=5173
ENV CHOKIDAR_USEPOLLING=true

EXPOSE 5173

CMD ["npm", "run", "dev"]
